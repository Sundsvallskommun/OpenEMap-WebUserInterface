<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='OpenEMap-view-layer-Add'>/**
</span> * Add layer view
 * View includes a drag/drop and collapsable layer tree
 */

Ext.define('OpenEMap.view.layer.Add' ,{
    extend: 'OpenEMap.view.layer.Tree',
    
    requires: [
        'OpenEMap.data.DataHandler',
        'OpenEMap.view.layer.TreeFilter',
        'OpenEMap.action.MetadataInfoColumn'
    ],

<span id='OpenEMap-view-layer-Add-cfg-title'>    title: 'LÃ¤gg till lager',
</span>
<span id='OpenEMap-view-layer-Add-cfg-width'>    width: 250,
</span><span id='OpenEMap-view-layer-Add-cfg-height'>    height: 550,
</span>
<span id='OpenEMap-view-layer-Add-cfg-headerPosition'>    headerPosition: 'top',
</span><span id='OpenEMap-view-layer-Add-cfg-collapsible'>    collapsible: true,
</span><span id='OpenEMap-view-layer-Add-cfg-collapseMode'>    collapseMode: 'header',
</span><span id='OpenEMap-view-layer-Add-cfg-collapseDirection'>    collapseDirection : 'right',
</span><span id='OpenEMap-view-layer-Add-cfg-titleCollapse'>    titleCollapse: true,
</span>
<span id='OpenEMap-view-layer-Add-cfg-viewConfig'>    viewConfig: {
</span>         plugins: {
            ptype: 'treeviewdragdrop',
            enableDrop: false
        },
        copy: true
    },

<span id='OpenEMap-view-layer-Add-cfg-plugins'>    // Layer tree filtering
</span>    plugins: {
        ptype: 'treefilter',
        allowParentFolders: true
    },
<span id='OpenEMap-view-layer-Add-cfg-dockedItems'>    dockedItems: [
</span>        {
            xtype: 'toolbar',
            dock: 'top',
            layout: 'fit',
            items: [{
                xtype: 'trigger',
                triggerCls: 'x-form-clear-trigger',
                onTriggerClick: function () {
                    this.reset();
                    this.focus();
                },
                listeners: {
                    change: function (field, newVal) {
                        var tree = field.up('treepanel');
                        tree.filter(newVal);
                    },
                    buffer: 250
                }
            }]
        }
    ],

<span id='OpenEMap-view-layer-Add-method-initComponent'>    initComponent: function() {
</span>        var me = this;
        this.on('checkchange', function(node, checked, eOpts) {
            node.cascadeBy(function(n){
                if(checked) {
                    me.loadLayer(n);
                } else {
                    me.unLoadLayer(n);
                }
            });
        });

        // Add columns
        this.columns = [
            {
                xtype: 'treecolumn',
                flex: 1,
                dataIndex: 'text'
            },
            me.metadataColumn
        ];

        // Create store for the layer tree
        this.store = Ext.create('OpenEMap.data.GroupedLayerTree');

        // Create server store
        this.serverStore = Ext.create('OpenEMap.data.Servers',{ 
            proxy: {
                url: OpenEMap.wsUrls.basePath + OpenEMap.wsUrls.servers,
                type: 'ajax',
                reader: {
                    type: 'json',
                    root: 'configs'
                }
            }
        });

        // Wait for server load to initiate layer tree
        this.serverStore.load({
            callback: function() {
                me.dataHandler.getLayers(function(layers) {
                    if(layers) {
                        var parser = new OpenEMap.config.Parser({
                            serverStore: me.serverStore 
                        });
                        var layerTree = parser.parseLayerTree(layers);

                        me.store.setRootNode({
                            text: 'Lager',
                            expanded: true,
                            layers: layerTree
                        });
                    }
                    
                });
            }
        });

        this.callParent(arguments);

        
    },

<span id='OpenEMap-view-layer-Add-method-loadLayer'>    /** 
</span>    * Load a layer to GeoExt.MapPanel
    * @param {Ext.data.NodeInterface}   node    tree node
    */
    loadLayer: function(node) {
        var layer = node.get('layer');
        if(layer &amp;&amp; layer !== '' &amp;&amp; this.mapPanel) {
            layer.setVisibility(true);
            layer.displayInLayerSwitcher = false;
            this.mapPanel.layers.add(layer);
        }
    },

<span id='OpenEMap-view-layer-Add-method-unLoadLayer'>    /** 
</span>    * Unload a layer from GeoExt.MapPanel
    * @param {Ext.data.NodeInterface}   node    tree node
    */
    unLoadLayer: function(node) {
        var layer = node.get('layer');
        if(layer &amp;&amp; layer !== '' &amp;&amp; this.mapPanel) {
            this.mapPanel.layers.remove(layer);
        }
    }

});</pre>
</body>
</html>
