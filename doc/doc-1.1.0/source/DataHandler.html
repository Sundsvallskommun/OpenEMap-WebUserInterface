<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='OpenEMap-data-DataHandler'>/**
</span> * Data handler, handles ajax-request against ws-backend
 * Used when no store is associated with the data
 */

Ext.define('OpenEMap.data.DataHandler', {

<span id='OpenEMap-data-DataHandler-property-metadataAbstractWsUrl'>    metadataAbstractWsUrl: null,
</span><span id='OpenEMap-data-DataHandler-property-metadataWsUrl'>    metadataWsUrl: null,
</span><span id='OpenEMap-data-DataHandler-property-layersWsUrl'>    layersWsUrl: null,
</span>
<span id='OpenEMap-data-DataHandler-property-metadataAbstractCache'>    metadataAbstractCache: {},
</span>    
<span id='OpenEMap-data-DataHandler-method-constructor'>    constructor: function(options) {
</span>        this.wsUrls = OpenEMap.wsUrls;
        Ext.apply(this,options);
    },

<span id='OpenEMap-data-DataHandler-method-getLayer'>    /**
</span>    * GET-request to get a specific layer
    * @param {number}   id          layer id
    * @param {Function} callback    callback-function on success
    */
    getLayer: function(id, callback) {
        if(this.wsUrls.layers &amp;&amp; id) {
            this.doRequest(
                {
                    url: this.wsUrls.basePath + this.wsUrls.layers + '/' + id
                },
                function(json) {
                    callback(json);
                }
            );
        }
    },


<span id='OpenEMap-data-DataHandler-method-getLayers'>    /**
</span>    * GET-request to get layers
    * @param {Function} callback    callback-function on success
    */
    getLayers: function(callback) {
        if(this.wsUrls.layers) {
            this.doRequest(
                {
                    url: this.wsUrls.basePath + this.wsUrls.layers
                },
                callback
            );
        }
    },

<span id='OpenEMap-data-DataHandler-method-getMetadata'>    /**
</span>    * GET-request to get metadata for specific UUID
    * @param {string}   UUID        layer metadata UUID
    * @param {Function} callback    callback-function on success
    */
    getMetadata: function(UUID, callback) {
        if(UUID &amp;&amp; this.wsUrls.metadata) {
            this.doRequest(
                {
                    url: this.wsUrls.basePath + this.wsUrls.metadata + '/' + UUID
                },
                callback
            );
        }
    },

<span id='OpenEMap-data-DataHandler-method-getMetadataAbstract'>    /**
</span>    * GET-request to get metadata abstract for specific UUID
    * @param {string}   UUID        layer metadata UUID
    * @param {Function} callback    callback-function on success
    */
    getMetadataAbstract: function(UUID, callback) {
        if(UUID &amp;&amp; this.wsUrls.metadata_abstract) {
            var me = this;
            // Cache metadata temporarily until page reload, to minize ajax requests
            if(me.metadataAbstractCache[UUID]) {
                callback(me.metadataAbstractCache[UUID]);
            } else {
                this.doRequest(
                    {
                        url: this.wsUrls.basePath + this.wsUrls.metadata_abstract + '/' + UUID
                    },
                    function(json) {
                        callback(json);
                        me.metadataAbstractCache[UUID] = json;
                    }
                );
            }
        }
    },

<span id='OpenEMap-data-DataHandler-method-updateConfiguration'>    /**
</span>    * PUT-request to update a configuration
    * @param {number}   id         map configuration id
    * @param {Object}   conf       map config object
    * @param {Function} callback   callback-function on success
    */
    updateConfiguration: function(id, conf, callback) {
        this.doRequest({
            url: this.wsUrls.basePath + this.wsUrls.configs + '/' + id,
            method: 'PUT',
            jsonData: conf
        }, callback);
    },

<span id='OpenEMap-data-DataHandler-method-saveNewConfiguration'>    /**
</span>    * POST-request to save a new configuration
    * @param {Object}   conf       map config object
    * @param {Function} callback   callback-function on success
    */
    saveNewConfiguration: function(conf, callback) {
        this.doRequest({
            url: this.wsUrls.basePath + this.wsUrls.configs,
            method: 'POST',
            jsonData: conf
        }, callback);
    },

<span id='OpenEMap-data-DataHandler-method-deleteConfiguration'>    /**
</span>    * DELETE-request to remove a configuration
    * @param {number}   id         map configuration id
    * @param {Object}   conf       map config object
    * @param {Function} callback   callback-function on success
    */
    deleteConfiguration: function(id, conf, callback) {
        this.doRequest({
            url: this.wsUrls.basePath + this.wsUrls.configs + '/' + id,
            method: 'DELETE',
            jsonData: conf
        }, callback);
    },

<span id='OpenEMap-data-DataHandler-method-doRequest'>    /**
</span>    * Handles Ajax-request.
    * @param {Object}   options     Ext.Ajax.request options 
    * @param {Function} callback    callback-function on success
    */
    doRequest: function(options, callback) {
        var me = this;
        if(options &amp;&amp; (options.method &amp;&amp; options.method === 'POST' &amp;&amp; options.method === 'PUT') &amp;&amp; !callback) {
            me.onFailure('no callback function');
            return false;
        };
        Ext.Ajax.request(Ext.apply({
                success: function(response) {
                    if(response &amp;&amp; response.responseText) {
                        var json = Ext.decode(response.responseText);
                        if(callback) {
                            callback(json);
                        }
                    } else {
                        me.onFailure();
                    }
                },
                failure: function(e) {
                    me.onFailure(e.status + ' ' + e.statusText + ', ' + options.url);
                }
            }, (options ? options : {})));
    },

<span id='OpenEMap-data-DataHandler-method-onFailure'>    /**
</span>    * Called on ajax-request failure or data not correct
    * @param {string}   msg     error message
    */
    onFailure: function(msg) {
        //TODO! handle failure
        console.error(msg);
        //Ext.Error.raise(msg);
    }


});</pre>
</body>
</html>
