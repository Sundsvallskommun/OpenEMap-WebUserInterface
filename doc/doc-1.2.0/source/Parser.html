<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*    
    Copyright (C) 2014 Härnösands kommun

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
*/
<span id='OpenEMap-config-Parser'>/**
</span> * Parser for configuration JSON
 * Set defaults, initializes OpenLayers and Ext JS stuff.
 */
Ext.define('OpenEMap.config.Parser', {
    requires : [ 
        'OpenEMap.data.Servers',
        'Ext.Ajax' 
    ],

<span id='OpenEMap-config-Parser-method-constructor'>    constructor: function(config) {
</span>        Ext.apply(this, config);
        this.callParent(arguments);
    },

<span id='OpenEMap-config-Parser-method-parse'>    /**
</span>     * Parse configuration JSON
     * 
     * Set defaults, initializes OpenLayers and Ext JS stuff.
     */
    parse : function(config) {
        // construct OpenLayers.Map options object
        var options = {
            &quot;fallThrough&quot; : true,
            &quot;controls&quot;: [&quot;Navigation&quot;, &quot;KeyboardDefaults&quot;],
            &quot;projection&quot;: &quot;EPSG:3006&quot;,
            &quot;resolutions&quot;: [280, 140, 70, 28, 14, 7, 4.2, 2.8, 1.4, 0.56, 0.28, 0.14, 0.112],
            &quot;extent&quot;: [608114, 6910996, 641846, 6932596],
            &quot;maxExtent&quot;: [487000.0, 6887000.0, 749144.0, 7149144.0],
            &quot;units&quot;: &quot;m&quot;,
            &quot;municipalities&quot;: ['Sundvsall', 'Timrå', 'Kramfors', 'Örnsköldsvik', 'Härnösand']
        };
        
        options.resolutions = config.resolutions || options.resolutions;
        options.units = config.units || options.units;
        options.projection = config.projection || options.projection;
        options.maxExtent = config.maxExtent;
        options.extent = config.extent;
        options.municipalities = config.municipalities || options.municipalities;
        options.controls = options.controls.map(this.createControl);
        
        // allow to override/add other options from map property 
        Ext.apply(options, config.map);
        
        // transform layers for backward compat
        layers = config.layers.map(this.transformLayer);
        
        // Create a Extjs layertree from configuration
        var layerTree = this.parseLayerTree(layers);

        // filter out plain layer definitions (no group)
        var layers = this.extractLayers(layerTree);
        
        options.allOverlays = !layers.some(this.isBaseLayer, this);
        
        // Create OpenLayers.Layer.WMS from layer definitions that describe WMS source
        options.layers = layers
            //.filter(this.isWMSLayer)
            .map(function(layer) {
                return layer.layer;
            });
        
        options.layers = options.layers.filter(function(layer) { return layer; });
        
        var map = new OpenLayers.Map(options);
        // Store a reference to the full layer tree
        map.layerTree = layerTree;
        // Store a reference to the layer switcher layer tree
        map.layerSwitcherLayerTree = this.getLayerSwitcherLayers(layerTree);

        return map;
    },

<span id='OpenEMap-config-Parser-method-parseLayerTree'>    /**
</span>    * Iterate over the layertree and create a ExtJS-tree structure
    */
    parseLayerTree: function(layers) {
        layers.forEach(this.iterateLayers, this);
        return layers;
    },

<span id='OpenEMap-config-Parser-method-getLayerSwitcherLayers'>    /**
</span>    * Get all layers and layer groups that should show up in the layer switcher
    */
    getLayerSwitcherLayers: function(layers) {
        return layers.filter(function(layer) { 
            return (layer.layers || (this.isWMSLayer(layer) &amp;&amp; !this.isBaseLayer(layer))) ? true : false;
        }, this);
    },

<span id='OpenEMap-config-Parser-method-extractLayers'>    /**
</span>     * Process layers config to return a flat array with layer definitions
     */
    extractLayers: function(layers) {
        // filter out plain layer definitions (no group)
        var plainLayers = layers.filter(function(layer) { return !layer.layers; });
        // filter out groups
        var groups = layers.filter(function(layer) { return layer.layers; }).map(function(layer) { return layer.layers; });
        // flatten groups into an array of layer definitions 
        var flattenedGroups = [].concat.apply([], groups);
        // concat all layer definitions
        layers = plainLayers.concat(flattenedGroups);
        // Reverse layers to make the top layer in config land on top in OpenLayers
        layers.reverse();

        return layers;
    },
<span id='OpenEMap-config-Parser-method-extractWFS'>    extractWFS: function(layers) {
</span>        layers = this.extractLayers(layers);
        layers = layers.filter(function(layer){ return layer.wfs; });
        return layers;
    },
<span id='OpenEMap-config-Parser-method-getOptions'>    getOptions: function(layer) {
</span>        if (layer.wms) {
            return layer.wms.options;
        } else if (layer.osm) {
            return layer.osm.options;
        } else if (layer.google) {
            return layer.google.options;
        } else if (layer.bing) {
            return layer.bing.options;
        }
    },
<span id='OpenEMap-config-Parser-method-isOpenLayersLayer'>    isOpenLayersLayer: function(layer) {
</span>        if (layer.wms || layer.osm || layer.google || layer.bing) {
            return true;
        } else {
            return false;
        }
    },
<span id='OpenEMap-config-Parser-method-isBaseLayer'>    isBaseLayer: function(layer) {
</span>        var options = this.getOptions(layer);
        if (options &amp;&amp; options.isBaseLayer) {
            return true;
        } else {
            return false;
        }
    },
<span id='OpenEMap-config-Parser-method-createControl'>    createControl: function(control) {
</span>        if (control.constructor == String) {
            return new OpenLayers.Control[control]();
        } else {
            return new OpenLayers.Control[control.type](control.options);
        }
    },
<span id='OpenEMap-config-Parser-method-isWMSLayer'>    isWMSLayer: function(layer) {
</span>        return layer.wms ? true : false;
    },
<span id='OpenEMap-config-Parser-method-transformLayer'>    /**
</span>     * Transform layer definition for back compatibility reasons
     */
    transformLayer: function(layer) {
        // if layer def has url assume it should be moved to wms property
        if (layer.url) {
            layer.wms = {
                    url: layer.url,
                    params: layer.params,
                    options: layer.options
            };
        }
        return layer;
    },
<span id='OpenEMap-config-Parser-method-createLayer'>    createLayer: function(layer) {
</span>        if (layer.wms) {
            return new OpenLayers.Layer.WMS(layer.name, layer.wms.url, layer.wms.params, layer.wms.options);
        } else if (layer.osm) {
            return new OpenLayers.Layer.OSM(layer.name, layer.osm.url, layer.osm.options);
        } else if (layer.google) {
            return new OpenLayers.Layer.Google(layer.name, layer.google.options);
        } else if (layer.bing) {
            return new OpenLayers.Layer.Bing(Ext.apply({name: layer.name}, layer.bing.options));
        } else {
            throw new Error(&quot;Unknown layer type&quot;);
        }
    },

<span id='OpenEMap-config-Parser-method-iterateLayers'>    iterateLayers: function(layer) {
</span>        // Set node text
        layer.text = layer.name;
        // Is node checked?
        layer.checked = layer.wms &amp;&amp; layer.wms.options ? layer.wms.options.visibility : false;
        // Get url from Server and set to layer
        if(typeof layer.serverId !== 'undefined' &amp;&amp; layer.serverId !== '') {
            var server = this.serverStore.getById(layer.serverId);
            if(server) {
                if(layer.wms &amp;&amp; !layer.wms.url) {
                    var wmsService = '/wms';
                    if(layer.wms.gwc) {
                        wmsService = '/gwc/service/wms';
                    }
                    layer.wms.url = server.get('url') + wmsService;
                }

                if(layer.wfs &amp;&amp; !layer.wfs.url) {
                    layer.wfs.url = server.get('url');
                }
            }
        }

        // Create and store a reference to OpenLayers layer for this node
        if(this.isOpenLayersLayer(layer)) {
            layer.layer = this.createLayer(layer);
        }
        // Do the node have sublayers, iterate over them
        if(layer.layers) {
            layer.expanded = layer.expanded == undefined ? true : layer.expanded;
            layer.layers.forEach(arguments.callee, this);
        } else {
            // If no sublayers, this is a leaf
            layer.leaf = true;
        }
    }

});
</pre>
</body>
</html>
