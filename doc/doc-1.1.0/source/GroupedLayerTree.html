<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='OpenEMap-data-GroupedLayerTree'>/**
</span> * Grouped layer tree store
 * Ext.data.TreeStore extended to support OpenEMap layer configuration including layer groups
 */

Ext.define('OpenEMap.data.GroupedLayerTree' ,{
    extend: 'Ext.data.TreeStore',

    requires: [
        'GeoExt.container.WmsLegend',
        'OpenEMap.model.GroupedLayerTreeModel'
    ],

<span id='OpenEMap-data-GroupedLayerTree-cfg-model'>    model: 'OpenEMap.model.GroupedLayerTreeModel',
</span><span id='OpenEMap-data-GroupedLayerTree-cfg-defaultRootProperty'>    defaultRootProperty: 'layers',
</span>
<span id='OpenEMap-data-GroupedLayerTree-cfg-proxy'>    proxy: {
</span>        type: 'memory'

    },

<span id='OpenEMap-data-GroupedLayerTree-property-maxLayerIndex'>    maxLayerIndex: 1000,
</span>
<span id='OpenEMap-data-GroupedLayerTree-cfg-listeners'>    listeners: {
</span>        beforeinsert: function(store, node, refNode, eOpts) { return this.onBeforeInsert(store, node, refNode); },
        beforeappend: function(store, node, eOpts) { return this.onBeforeAppend(store, node); },
        insert: function(store, node, refNode, eOpts) { this.onInsertAndAppend(node); },
        append: function(store, node, index, eOpts) { this.onInsertAndAppend(node); },
        remove: function(store, node, isMove, eOpts) { this.onRemove(store, node, isMove); }
    },

<span id='OpenEMap-data-GroupedLayerTree-method-constructor'>    constructor: function(config) {
</span>        config = Ext.apply({}, config);
        this.callParent([config]);
        
    },
    
<span id='OpenEMap-data-GroupedLayerTree-method-getLayerConfiguration'>    /**
</span>    * Returns all layers as OpenEMap layer configuration tree.
    * @return {object} layerConfig  OpenEMap layer configuration
    */
    getLayerConfiguration: function() {
        var layerConfig = [];
        this.getRootNode().childNodes.forEach(function(node, i) {
            layerConfig[i] = {
                name: node.get('name'),
                layers: []
            };
            
            node.childNodes.forEach(function(subnode) {
                layerConfig[i].layers.push({
                    name: subnode.get('name'),
                    wms: typeof subnode.get('wms') === 'string' ? {} : subnode.get('wms'),
                    wfs: typeof subnode.get('wfs') === 'string' ? {} : subnode.get('wfs'),
                    metadata: typeof subnode.get('metadata') === 'string' ? {} : subnode.get('metadata')
                });
            });
        });
        return layerConfig;
    },

<span id='OpenEMap-data-GroupedLayerTree-method-onBeforeAppend'>    /**
</span>    * Before append to store
    * @param {Ext.data.Model} node
    * @param {Ext.data.Model} appendNode
    */
    onBeforeAppend: function(node, appendNode) {
        // Prevent groups from being added to groups
        if((node &amp;&amp; !node.isRoot()) &amp;&amp; !appendNode.isLeaf()) {
            return false;
        }
        return true;
    },

<span id='OpenEMap-data-GroupedLayerTree-method-onBeforeInsert'>    /**
</span>    * Before insert to store
    * @param {Ext.data.Store} store
    * @param {Ext.data.Model} node
    * @param {Ext.data.Model} refNode
    */
    onBeforeInsert: function(store, node, refNode) {
        // Prevent groups from being added to groups
        if(!refNode.parentNode.isRoot() &amp;&amp; !node.isLeaf()) {
            return false;
        }
        return true;
    },

<span id='OpenEMap-data-GroupedLayerTree-method-onInsertAndAppend'>    /**
</span>     * Handler for a store's insert and append event.
     *
     * @param {Ext.data.Model} node
     */
    onInsertAndAppend: function(node) {
        if(!this._inserting) {
            this._inserting = true;
            
            // Add this node layers and subnodes to map.
            node.cascadeBy(function(subnode) {
                var layer = subnode.get('layer');

                // Add getLayer function to support GeoExt
                subnode.getLayer = function() {
                    return this.get('layer');
                };
                // Add WMS legened 
                this.addWMSLegend(subnode);

                if(layer &amp;&amp; layer !== '' &amp;&amp; this.map) {
                    var mapLayer = this.map.getLayer(layer);
                    if(mapLayer === null &amp;&amp; layer &amp;&amp; layer.displayInLayerSwitcher === true) {
                        this.map.addLayer(layer);
                    }
                }
            }, this);

            this.reorderLayersOnMap();
            
            delete this._inserting;
        }
    },

<span id='OpenEMap-data-GroupedLayerTree-method-onRemove'>    /**
</span>     * Handler for a store's remove event.
     *
     * @param {Ext.data.Store} store
     * @param {Ext.data.Model} node
     * @param {Boolean} isMove
     * @private
     */
    onRemove: function(store, node, isMove) {
        if(!this._removing &amp;&amp; !isMove) {
            this._removing = true;
            // Remove layer and sublayers from map
            node.cascadeBy(function(subnode) {
                var layer = subnode.get('layer');
                if(layer &amp;&amp; layer.map) {
                    this.map.removeLayer(layer);
                }
            }, this);

            delete this._removing;
        }
    },

<span id='OpenEMap-data-GroupedLayerTree-method-reorderLayersOnMap'>    /**
</span>     * Reorder map layers from store order
     *
     * @private
     */
    reorderLayersOnMap: function() {
        var node = this.getRootNode();
        if(node) {
            var i = this.maxLayerIndex;
            node.cascadeBy(function(subnode) {
                var layer = subnode.get('layer');
                
                if(layer) {
                    layer.setZIndex(i);
                    i--;
                }
               
            }, this);
        }
    },

<span id='OpenEMap-data-GroupedLayerTree-method-addWMSLegend'>    /**
</span>    * Adds a WMS-legend to a node
    * @param {Ext.data.Model} node
    * @return {Ext.data.Model} node
    */
    addWMSLegend: function(node) {
        var layer = node.get('layer');
    
        if (layer) {
            if (Ext.isIE9) return node;
            if (layer.legendURL) {
                node.set('legendURL', layer.legendURL);
                node.gx_urllegend = Ext.create('GeoExt.container.UrlLegend', {
                    layerRecord: node,
                    showTitle: false,
                    hidden: true,
                    deferRender: true,
                    // custom class for css positioning
                    // see tree-legend.html
                    cls: &quot;legend&quot;
                });
            } else if (layer.CLASS_NAME == &quot;OpenLayers.Layer.WMS&quot;) {
                node.gx_wmslegend = Ext.create('GeoExt.container.WmsLegend', {
                    layerRecord: node,
                    showTitle: false,
                    hidden: true,
                    deferRender: true,
                    // custom class for css positioning
                    // see tree-legend.html
                    cls: &quot;legend&quot;
                });
            }
        }
        return node;
    },

<span id='OpenEMap-data-GroupedLayerTree-method-unbind'>    /**
</span>     * Unbind this store from the map it is currently bound.
     */
    unbind: function() {
        var me = this;
        me.un('beforeinsert', me.onBeforeInsert, me);
        me.un('beforeappend', me.onBeforeAppend, me);
        me.un('insert', me.onInsertAndAppend, me);
        me.un('append', me.onInsertAndAppend, me)
        me.un('remove', me.onRemove, me);
        me.map = null;
    },

<span id='OpenEMap-data-GroupedLayerTree-method-destroy'>    /**
</span>     * Unbinds listeners by calling #unbind prior to being destroyed.
     *
     * @private
     */
    destroy: function() {
        //this.unbind();
        //this.callParent();
    }
});
</pre>
</body>
</html>
